{% extends "base.html" %}

{% block title %}{{ folder_name }} - Manual Otomotif{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<div class="breadcrumb">
    <a href="/">
        <i class="fas fa-home"></i>
        Beranda
    </a>
    <span class="separator"><i class="fas fa-chevron-right"></i></span>
    <span class="current">{{ folder_name }}</span>
</div>

<!-- Page Header -->
<div class="page-header">
    <h2>
        <i class="fas fa-folder-open"></i>
        {{ folder_name }}
    </h2>
    <div class="controls">
        <div class="view-toggle">
            <button class="active" onclick="toggleView('grid')">
                <i class="fas fa-th"></i>
            </button>
            <button onclick="toggleView('list')">
                <i class="fas fa-list"></i>
            </button>
        </div>
        <div class="sort-dropdown">
            <select onchange="sortFiles(this.value)">
                <option value="name-asc">Nama A-Z</option>
                <option value="name-desc">Nama Z-A</option>
                <option value="date-new">Terbaru</option>
                <option value="date-old">Terlama</option>
            </select>
        </div>
    </div>
</div>

{% if items %}
    {% set file_count = namespace(value=0) %}
    {% set folder_count = namespace(value=0) %}
    {% for item in items %}
        {% if item.is_directory %}
            {% set folder_count.value = folder_count.value + 1 %}
        {% else %}
            {% set file_count.value = file_count.value + 1 %}
        {% endif %}
    {% endfor %}

    <!-- Stats -->
    <div class="stats">
        <div class="stat-card">
            <div class="stat-icon blue">
                <i class="fas fa-folder"></i>
            </div>
            <div class="stat-info">
                <h4>Folder</h4>
                <p>{{ folder_count.value }}</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon green">
                <i class="fas fa-file"></i>
            </div>
            <div class="stat-info">
                <h4>File</h4>
                <p>{{ file_count.value }}</p>
            </div>
        </div>
    </div>

    <!-- Items Cards -->
    <div class="cards-container">
    {% for item in items %}
        {% if item.is_directory %}
            <div class="card folder" onclick="window.location.href='/folder/{{ item.id }}'" data-date="{{ item.modified_time }}">
                <div class="card-icon">
                    <i class="fas fa-folder" style="color: #f39c12;"></i>
                </div>
                <div class="card-content">
                    <div class="card-title">{{ item.name }}</div>
                    <div class="card-meta">
                        <span>
                            <i class="fas fa-folder"></i>
                            Folder
                        </span>
                        <span>
                            <i class="fas fa-arrow-right"></i>
                        </span>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="card" data-date="{{ item.modified_time }}">
                <div class="card-icon">
                    {# --- Deteksi berdasarkan mime_type (jika ada) dan ekstensi file --- #}
                    {% if item.mime_type and item.mime_type == 'application/pdf' or item.name.endswith('.pdf') %}
                        <i class="fas fa-file-pdf" style="color: #e74c3c;"></i>
                    {% elif item.mime_type and ('word' in item.mime_type or 'msword' in item.mime_type) or item.name.endswith(('.doc', '.docx')) %}
                        <i class="fas fa-file-word" style="color: #2980b9;"></i>
                    {% elif item.mime_type and ('excel' in item.mime_type or 'spreadsheet' in item.mime_type) or item.name.endswith(('.xls', '.xlsx')) %}
                        <i class="fas fa-file-excel" style="color: #27ae60;"></i>
                    {% elif item.name.endswith(('.jpg', '.jpeg', '.png', '.gif', '.bmp')) %}
                        <i class="fas fa-file-image" style="color: #e67e22;"></i>
                    {% else %}
                        <i class="fas fa-file" style="color: #95a5a6;"></i>
                    {% endif %}
                </div>
                <div class="card-content">
                    <div class="card-title">{{ item.name }}</div>
                    <div class="card-meta">
                        <span>
                            <i class="fas fa-hdd"></i>
                            {{ item.size | filesizeformat }}
                        </span>
                        <div style="display: flex; gap: 8px;">
                            <button class="download-btn" onclick="event.stopPropagation(); downloadFile('{{ item.id }}', '{{ item.name }}')">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="download-btn" style="background: var(--primary-color);" onclick="window.open('/file/{{ item.id }}', '_blank')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    {% endfor %}
    </div>
{% else %}
    <div style="text-align: center; padding: 60px 20px; background: var(--bg-secondary); border-radius: 16px; box-shadow: var(--shadow);">
        <i class="fas fa-folder-open" style="font-size: 64px; color: var(--text-secondary); margin-bottom: 16px;"></i>
        <h3 style="color: var(--text-primary); margin-bottom: 8px;">Folder Kosong</h3>
        <p style="color: var(--text-secondary);">Tidak ada file atau folder di lokasi ini.</p>
    </div>
{% endif %}
{% endblock %}

{% block sidebar %}
    <nav>
        <h3>Kategori</h3>
        <ul>
        {% for name, folder_id, count in root_list %}
            <li>
                <a href="/folder/{{ folder_id }}">
                    {{ name }}
                    <small>({{ count }})</small>
                </a>
            </li>
        {% endfor %}
        </ul>

        {% if items %}
            {% set has_subfolders = namespace(value=false) %}
            {% for item in items %}
                {% if item.is_directory %}
                    {% set has_subfolders.value = true %}
                {% endif %}
            {% endfor %}
            {% if has_subfolders.value %}
                <h3>Subfolder</h3>
                <ul>
                {% for item in items if item.is_directory %}
                    <li>
                        <a href="/folder/{{ item.id }}">
                            <i class="fas fa-folder" style="margin-right: 6px; font-size: 12px;"></i>
                            {{ item.name[:30] }}{% if item.name|length > 30 %}...{% endif %}
                        </a>
                    </li>
                {% endfor %}
                </ul>
            {% endif %}
        {% endif %}
    </nav>
{% endblock %}

{% block extra_js %}
<script>
function downloadFile(fileId, fileName) {
    const link = document.createElement('a');
    link.href = `/download/${fileId}`;
    link.download = fileName;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
</script>
{% endblock %}